import"./bubble_simulation.8d2f6bb2.js";var t=globalThis,i={},s={},e=t.parcelRequire0087;null==e&&((e=function(t){if(t in i)return i[t].exports;if(t in s){var e=s[t];delete s[t];var h={id:t,exports:{}};return i[t]=h,e.call(h.exports,h,h.exports),h.exports}var a=Error("Cannot find module '"+t+"'");throw a.code="MODULE_NOT_FOUND",a}).register=function(t,i){s[t]=i},t.parcelRequire0087=e),e.register;var h=e("dyjou"),a=e("ilwiq"),r=e("9sWXr"),n=e("5Rd1x");class l{constructor(){this.alpha=1/1024,this.beta=1/502,this.gamma=1/502,this.rho=1e3,this.g=9.8,this.p_atm=101325,this.wallThickness=.2,this.S_B=.0142,this.S_C=.0142,this.S_A=this.S_B+this.S_C,this.V_D0=.00355,this.h_B0_ref=.04,this.h_C0_ref=.21,this.h_6=.33,this.H=.25,this.eta=.001,this.S=285e-7,this.L1=.22,this.L2=.31,this.B1=8*Math.PI*this.eta*this.L1/this.S,this.B2=8*Math.PI*this.eta*this.L2/this.S,this.h_A_init=.06,this.h_B_init=.04,this.h_C_init=.2,this.EPS_DHB=1e-4,this.H_EPSILON=1e-5,this.T_GUARD=10,this.t=0,this.h_A=0,this.h_B=0,this.h_C=0,this.v2=0,this.v4=0,this.isStable=!1,this.p_D=this.p_atm,this.reset()}reset(){this.h_A=this.h_A_init,this.h_B=this.h_B_init,this.h_C=this.h_C_init,this.t=0,this.v2=0,this.v4=0,this.isStable=!1;let t=(this.h_B0_ref-this.h_B_init)*this.S_B+(this.h_C0_ref-this.h_C_init)*this.S_C,i=this.V_D0+t;this.p_D=this.p_atm*this.V_D0/i}system(t,i,s){let e=(this.h_B0_ref-i)*this.S_B+(this.h_C0_ref-s)*this.S_C,h=this.V_D0+e;this.p_D=this.p_atm*this.V_D0/h;let a=this.p_atm-this.p_D+this.rho*this.g*(t+this.H-i),r=this.p_D-this.p_atm+this.rho*this.g*(s-this.h_6),n=(-this.B1+Math.sqrt(this.B1**2+2*this.rho*Math.max(a,0)))/this.rho,l=(-this.B2+Math.sqrt(this.B2**2+2*this.rho*Math.max(r,0)))/this.rho;this.v2=n,this.v4=l;let o=-this.alpha*n+this.alpha*l;return[o,this.beta*n,-this.gamma*l]}step(t){if(this.isStable)return;if(this.h_B<this.H_EPSILON){this.h_B=0,this.isStable=!0,this.v2=0,this.v4=0;return}let[i,s,e]=this.system(this.h_A,this.h_B,this.h_C);if(this.t>this.T_GUARD&&Math.abs(s)<this.EPS_DHB){this.isStable=!0,this.v2=0,this.v4=0;return}this.h_A+=i*t,this.h_B=Math.max(0,this.h_B+s*t),this.h_C+=e*t,this.t+=t,this.h_A=Math.max(0,this.h_A),this.h_C=Math.max(0,this.h_C)}}class o{constructor(t="scene-container"){if(this.container=document.getElementById(t),!this.container)throw Error(`Container element with id '${t}' not found.`);this.clock=new h.Clock(!1),this.elapsedTime=0,this.accumulator=0,this.scene=new h.Scene,this.renderer=new a.WebGLRenderer({antialias:!0}),this.controls=null,this.camera2D=null,this.camera3D=null,this.camera=null,this.h_jet=0,this.currentColors=null,this.themeObserver=null,this.scale=20,this.physics=new l,this.waterA=null,this.waterB=null,this.waterC=null,this.waterCascade=null,this.waterPipe14=null,this.waterPipe56=null,this.pipe56=null,this.cascadeCurve=null,this.textOverlay=null,this.textGroups={},this.dyeMassA={r:0,g:0,b:0},this.dyeMassB={r:0,g:0,b:0},this.dyeMassC={r:0,g:0,b:0},this.initialConcentration=1,this.H_scaled=this.physics.H*this.scale,this.h6_scaled=this.physics.h_6*this.scale,this.worldWidth=.3*this.scale,this.worldDepth=.1*this.scale,this.internalWallBCH_unscaled=.22,this.internalWallBCH=this.internalWallBCH_unscaled*this.scale,this.topBasinY=this.H_scaled,this.topBasinHeight_unscaled=6/this.scale,this.topBasinHeight=this.topBasinHeight_unscaled*this.scale,this.h_A_max=this.topBasinHeight_unscaled-.01,this.h_BC_max=this.internalWallBCH_unscaled-.01,this.initialHeights_m={h_A:.06,h_B:.04,h_C:.2},this.guiParams={isRunning:!1,timeScale:1,viewMode:"3D",h_A_cm:100*this.initialHeights_m.h_A,h_B_cm:100*this.initialHeights_m.h_B,h_C_cm:100*this.initialHeights_m.h_C,playPause:()=>{this.guiParams.isRunning=!this.guiParams.isRunning,this.handlePlayPause()},reset:()=>{this.resetAll()}},this.pipeInnerRadius=Math.sqrt(this.physics.S/Math.PI),this.pipeOuterRadius=this.pipeInnerRadius+.001,this.jetRadius=this.pipeInnerRadius,this.updatePhysicsInitials(),this.initThree(),this.setupSceneGeometry(),this.setupGUI(),this.addTextLabels(),this.resetAll(),this.animate=this.animate.bind(this),this.animate()}updatePhysicsInitials(){this.physics.h_A_init=this.guiParams.h_A_cm/100,this.physics.h_B_init=this.guiParams.h_B_cm/100,this.physics.h_C_init=this.guiParams.h_C_cm/100}getCurrentTheme(){return"dark"===document.documentElement.getAttribute("data-theme")?"dark":"light"}updateSceneTheme(){let t=this.getCurrentTheme();this.scene&&(this.scene.background=new a.Color(0xffffff*("dark"!==t)))}setupThemeObserver(){this.themeObserver=new MutationObserver(t=>{for(let i of t)"attributes"===i.type&&"data-theme"===i.attributeName&&this.updateSceneTheme()}),this.themeObserver.observe(document.documentElement,{attributes:!0})}initThree(){this.updateSceneTheme(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.container.appendChild(this.renderer.domElement);let t=this.container.clientWidth/this.container.clientHeight;this.camera2D=new a.OrthographicCamera(-15*t,15*t,15,-15,.1,100),this.camera2D.position.set(0,0,50),this.camera2D.lookAt(0,this.H_scaled,0),this.camera3D=new a.PerspectiveCamera(50,t,.1,200),this.camera3D.position.set(15,12,25),this.camera3D.lookAt(0,this.H_scaled,0),this.camera=this.camera3D,this.controls=new(0,n.OrbitControls)(this.camera3D,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.target.set(0,this.H_scaled,0),this.controls.enabled="3D"===this.guiParams.viewMode;let i=new h.AmbientLight(0xffffff,.7);this.scene.add(i);let s=new h.DirectionalLight(0xffffff,1);s.position.set(10,20,15),s.castShadow=!0,this.scene.add(s),window.addEventListener("resize",this.onWindowResize.bind(this)),window.addEventListener("blur",()=>{this.guiParams.isRunning&&this.guiParams.playPause()}),this.setupThemeObserver()}setupSceneGeometry(){let t=new h.MeshPhysicalMaterial({transmission:.9,thickness:1.5*this.scale,roughness:.1,ior:1.33,transparent:!0,opacity:.7,side:a.DoubleSide,depthWrite:!0}),i=new h.MeshPhysicalMaterial({color:0xffffff,transmission:.95,thickness:.5,roughness:.05,ior:1.52,transparent:!0,opacity:.6,side:a.DoubleSide,depthWrite:!1}),s=this.worldWidth/2,e=this.worldDepth,r=new h.MeshPhysicalMaterial({...t}),n=new h.MeshPhysicalMaterial({...t}),l=new h.MeshPhysicalMaterial({...t}),o=new a.BoxGeometry(1,1,1);this.waterA=new a.Mesh(o,r),this.waterA.scale.set(this.worldWidth,1,e),this.waterA.renderOrder=2,this.scene.add(this.waterA),this.waterB=new a.Mesh(o,n),this.waterB.scale.set(s,1,e),this.waterB.position.x=-s/2,this.waterB.renderOrder=2,this.scene.add(this.waterB),this.waterC=new a.Mesh(o,l),this.waterC.scale.set(s,1,e),this.waterC.position.x=s/2,this.waterC.renderOrder=2,this.scene.add(this.waterC);let c=this.physics.wallThickness,d=(t,s,e,h,r,n)=>{let l=new a.BoxGeometry(t,s,e),o=new a.Mesh(l,i.clone());return o.position.set(h,r,n),o.renderOrder=1,this.scene.add(o),o};d(this.worldWidth+2*c,c,e+2*c,0,-c/2,0),d(this.worldWidth+2*c,c,e+2*c,0,this.H_scaled,0),d(this.worldWidth+2*c,c,e+2*c,0,this.topBasinY+this.topBasinHeight,0);let p=this.topBasinY+this.topBasinHeight;d(c,p,e+c,-this.worldWidth/2-c/2,p/2-c/2,0),d(c,p,e+c,this.worldWidth/2+c/2,p/2-c/2,0),d(this.worldWidth+2*c,p,c,0,p/2-c/2,-e/2-c/2),d(this.worldWidth+2*c,p,c,0,p/2-c/2,e/2+c/2),d(c,this.internalWallBCH,e,0,this.internalWallBCH/2,0);let m=this.scale,u=this.pipeInnerRadius*m,_=this.pipeOuterRadius*m,y=(t,s,e,r,n,l)=>{let o=new h.Shape;o.absarc(0,0,t,0,2*Math.PI,!1);let c=new h.Path;c.absarc(0,0,s,0,2*Math.PI,!0),o.holes.push(c);let d=new h.ExtrudeGeometry(o,{depth:e,bevelEnabled:!1}),p=new a.Mesh(d,i.clone());return p.rotation.x=Math.PI/2,p.position.set(r,n+e/2,l),p.renderOrder=1,this.scene.add(p),p};y(_,u,this.H_scaled,-s/2,this.H_scaled/2,0),this.pipe56=y(_,u,this.h6_scaled,s/2,this.h6_scaled/2,0);let w=new h.CylinderGeometry(u,u,this.H_scaled,16);this.waterPipe14=new a.Mesh(w,t.clone()),this.waterPipe14.position.set(-s/2,this.H_scaled/2,0),this.waterPipe14.visible=!1,this.waterPipe14.renderOrder=2,this.scene.add(this.waterPipe14);let C=new h.CylinderGeometry(u,u,this.h6_scaled,16);this.waterPipe56=new a.Mesh(C,t.clone()),this.waterPipe56.position.set(s/2,this.h6_scaled/2,0),this.waterPipe56.visible=!1,this.waterPipe56.renderOrder=2,this.scene.add(this.waterPipe56);let M=new h.MeshPhysicalMaterial({color:4235519,transmission:.7,thickness:.1*this.scale,roughness:.3,ior:1.33,transparent:!0,opacity:1,side:a.DoubleSide,depthWrite:!1}),x=new h.LineCurve3(new a.Vector3(0,0,0),new a.Vector3(1,1,1)),g=new h.TubeGeometry(x,20,this.jetRadius*m,8,!1);this.waterCascade=new a.Mesh(g,M),this.waterCascade.visible=!1,this.waterCascade.renderOrder=3,this.scene.add(this.waterCascade)}setupGUI(){let t=new(0,r.default)({title:"Heron's Fountain Controls"});t.add(this.guiParams,"playPause").name("▶️ / ⏸️ Start/Pause"),t.add(this.guiParams,"reset").name("\uD83D\uDD04 Reset All"),t.add(this.guiParams,"timeScale",.1,5,.1).name("Time Scale"),t.add(this.guiParams,"viewMode",["2D","3D"]).name("View Mode").onChange(t=>{this.camera="2D"===t?this.camera2D:this.camera3D,this.controls.enabled="3D"===t,this.onWindowResize()});let i=t.addFolder("Initial Water Levels (cm)"),s=()=>{this.updatePhysicsInitials(),this.resetAll()};i.add(this.guiParams,"h_A_cm",0,100*this.h_A_max,.1).name("Basin A (h_A)").onFinishChange(s),i.add(this.guiParams,"h_B_cm",0,100*this.h_BC_max,.1).name("Basin B (h_B)").onFinishChange(s),i.add(this.guiParams,"h_C_cm",0,100*this.h_BC_max,.1).name("Basin C (h_C)").onFinishChange(s)}resetColors(){let t=this.physics.h_A_init*this.physics.S_A,i=this.physics.h_B_init*this.physics.S_B,s=this.physics.h_C_init*this.physics.S_C;this.dyeMassA={r:t*this.initialConcentration,g:0,b:0},this.dyeMassB={r:0,g:i*this.initialConcentration,b:0},this.dyeMassC={r:0,g:0,b:s*this.initialConcentration},this.waterA&&this.waterA.material.color.setRGB(1,0,0),this.waterB&&this.waterB.material.color.setRGB(0,1,0),this.waterC&&this.waterC.material.color.setRGB(0,0,1),this.waterCascade&&this.waterCascade.material.color.setRGB(0,0,1)}resetAll(){this.guiParams.isRunning=!1,this.clock.stop(),this.elapsedTime=0,this.accumulator=0,this.physics.reset(),this.h_jet=0,this.resetColors(),this.updateWaterMeshes(),this.waterCascade.visible=!1,this.waterPipe14&&(this.waterPipe14.visible=!1),this.waterPipe56&&(this.waterPipe56.visible=!1),this.updateTextLabels(),this.updateWaterColors(0)}handlePlayPause(){this.guiParams.isRunning?(this.physics.isStable&&this.resetAll(),this.guiParams.isRunning=!0,this.clock.start()):this.clock.stop()}updateWaterMeshes(){let{h_A:t,h_B:i,h_C:s}=this.physics,e=this.scale,h=Math.max(.01,t*e),a=Math.max(.01,i*e);this.waterB.visible=i>0;let r=Math.max(.01,s*e);this.waterA.scale.y=h,this.waterA.position.y=this.H_scaled+h/2,this.waterB.scale.y=a,this.waterB.position.y=a/2,this.waterC.scale.y=r,this.waterC.position.y=r/2}updateCascade(t){if(this.physics.isStable){this.waterCascade.visible=!1;return}let i=Math.max(0,this.physics.v4);if(i<.1||!this.guiParams.isRunning){this.waterCascade.visible=!1;return}this.waterCascade.visible=!0;let s=this.scale,e=this.physics.g,r=this.pipe56.position.x,n=this.pipe56.position.z,l=this.h6_scaled,o=this.waterA.position.y+this.waterA.scale.y/2,c=85*Math.PI/180,d=i*Math.sin(c),p=i*Math.cos(c),m=o-.5*this.jetRadius*s,u=.5*e*s,_=-d*s,y=_*_-4*u*(m-l),w=0;y>=0&&(w=(-_+Math.sqrt(y))/(2*u));let C=-p*(w=isNaN(w)?.2:Math.max(.1,w))*s,M=new a.Vector3(r,l,n),x=new a.Vector3(r+C,m,n),g=d/e,B=Math.max(l+d*g*s-.5*e*g*g*s,l),b=new a.Vector3(M.x+(x.x-M.x)*(1/3),B,M.z),v=new a.Vector3(M.x+(x.x-M.x)*(2/3),B,x.z);this.cascadeCurve=new h.CubicBezierCurve3(M,b,v,x),this.waterCascade.geometry&&this.waterCascade.geometry.dispose(),this.waterCascade.geometry=new h.TubeGeometry(this.cascadeCurve,30,this.jetRadius*s,8,!1),this.h_jet=d*d/(2*e)}updateWaterColors(t){if(t<=0)return;let i=this.physics.h_A*this.physics.S_A+1e-6,s=this.physics.h_B*this.physics.S_B+1e-6,e=this.physics.h_C*this.physics.S_C+1e-6,h=this.physics.gamma*this.physics.v4*this.physics.S_C*t,a=this.physics.beta*this.physics.v2*this.physics.S_B*t;if(h>0&&this.physics.v4>.01){let t=this.dyeMassC.r/e,i=this.dyeMassC.g/e,s=this.dyeMassC.b/e,a=t*h,r=i*h,n=s*h;this.dyeMassA.r+=a,this.dyeMassA.g+=r,this.dyeMassA.b+=n,this.dyeMassC.r=Math.max(0,this.dyeMassC.r-a),this.dyeMassC.g=Math.max(0,this.dyeMassC.g-r),this.dyeMassC.b=Math.max(0,this.dyeMassC.b-n)}if(a>0&&this.physics.v2>.01){let t=this.dyeMassA.r/i,s=this.dyeMassA.g/i,e=this.dyeMassA.b/i,h=t*a,r=s*a,n=e*a;this.dyeMassB.r+=h,this.dyeMassB.g+=r,this.dyeMassB.b+=n,this.dyeMassA.r=Math.max(0,this.dyeMassA.r-h),this.dyeMassA.g=Math.max(0,this.dyeMassA.g-r),this.dyeMassA.b=Math.max(0,this.dyeMassA.b-n)}let r=t=>Math.max(0,Math.min(t,1)),n=r(this.dyeMassA.r/i/this.initialConcentration),l=r(this.dyeMassA.g/i/this.initialConcentration),o=r(this.dyeMassA.b/i/this.initialConcentration),c=r(this.dyeMassB.r/s/this.initialConcentration),d=r(this.dyeMassB.g/s/this.initialConcentration),p=r(this.dyeMassB.b/s/this.initialConcentration),m=r(this.dyeMassC.r/e/this.initialConcentration),u=r(this.dyeMassC.g/e/this.initialConcentration),_=r(this.dyeMassC.b/e/this.initialConcentration);this.waterA.material.color.setRGB(r(1-l-o),r(1-n-o),r(1-n-l)),this.waterB.material.color.setRGB(r(1-d-p),r(1-c-p),r(1-c-d)),this.waterC.material.color.setRGB(r(1-u-_),r(1-m-_),r(1-m-u)),this.waterCascade.material.color.copy(this.waterC.material.color),this.waterPipe56.material.color.copy(this.waterC.material.color),this.waterPipe14.material.color.copy(this.waterA.material.color)}updatePipeWaterLevels(){let t=this.scale,i=this.guiParams.isRunning&&!this.physics.isStable,s=.01*t,e=this.physics.h_A,h=this.physics.h_B,a=Math.max(0,this.physics.H-h)*t;i&&this.physics.v2>.01&&e>0&&a>s?(this.waterPipe14.visible=!0,this.waterPipe14.scale.y=Math.max(.001,a/this.H_scaled),this.waterPipe14.position.y=h*t+a/2):this.waterPipe14.visible=!1;let{p_D:r,rho:n,g:l,h_C:o,h_6:c,p_atm:d}=this.physics,p=(r-d)/(n*l)+o,m=(p=Math.max(0,p=Math.min(p=Math.max(o,p),c)))*t;m>s&&i?(this.waterPipe56.visible=!0,this.waterPipe56.scale.y=Math.max(.001,m/this.h6_scaled),this.waterPipe56.position.y=m/2):this.waterPipe56.visible=!1}addTextLabels(){this.textOverlay&&this.textOverlay.remove(),this.textOverlay=document.createElement("div"),this.textOverlay.className="text-label-overlay",this.container.appendChild(this.textOverlay);let t=t=>{let i=document.createElement("div");return i.className="label-group",i.id=t,this.textOverlay.appendChild(i),i};this.textGroups.A=t("label-A"),this.textGroups.B=t("label-B"),this.textGroups.C=t("label-C"),this.textGroups.Time=t("label-Time"),this.textGroups.Jet=t("label-Jet")}toScreenPosition(t,i,s){let e=s.clientWidth,h=s.clientHeight,a=t.clone().project(i);return a.x=(a.x+1)/2*e,a.y=-(a.y-1)/2*h,{x:a.x,y:a.y}}updateTextLabels(){if(!this.textGroups.A)return;this.scale;let t=this.renderer.domElement,i=new a.Vector3(0,this.H_scaled+this.topBasinHeight-1,0),s=new a.Vector3(-this.worldWidth/4,this.H_scaled-1,0),e=new a.Vector3(this.worldWidth/4,this.H_scaled-1,0),h=new a.Vector3(this.worldWidth/4,this.h6_scaled+2,0),r=this.toScreenPosition(i,this.camera,t);this.textGroups.A.style.left=`${r.x}px`,this.textGroups.A.style.top=`${r.y}px`,this.textGroups.A.innerHTML=`
                <div>Basin A</div>
                <div>h_A: ${(100*this.physics.h_A).toFixed(1)} cm</div>
                `;let n=this.toScreenPosition(s,this.camera,t);this.textGroups.B.style.left=`${n.x}px`,this.textGroups.B.style.top=`${n.y}px`,this.textGroups.B.innerHTML=`
                <div>Basin B</div>
                <div>h_B: ${(100*this.physics.h_B).toFixed(1)} cm</div>
                `;let l=this.toScreenPosition(e,this.camera,t);this.textGroups.C.style.left=`${l.x}px`,this.textGroups.C.style.top=`${l.y}px`,this.textGroups.C.innerHTML=`
                <div>Basin C</div>
                <div>h_C: ${(100*this.physics.h_C).toFixed(1)} cm</div>
                `;let o=this.toScreenPosition(h,this.camera,t);this.textGroups.Jet.style.left=`${o.x}px`,this.textGroups.Jet.style.top=`${o.y}px`,this.textGroups.Jet.innerHTML=`
                <div>Jet</div>
                <div>v_4: ${this.physics.v4.toFixed(2)} m/s</div>
                <div>h_jet: ${(100*this.h_jet).toFixed(1)} cm</div>
                `,this.textGroups.Time.style.left="50%",this.textGroups.Time.style.top="20px";let c=this.physics.isStable?"STABLE (B empty)":this.guiParams.isRunning?"RUNNING":"PAUSED";this.textGroups.Time.innerHTML=`
                <div>Time: ${this.physics.t.toFixed(2)} s</div>
                <div>State: ${c}</div>
                `}onWindowResize(){let t=this.container.clientWidth/this.container.clientHeight;this.camera2D.left=-15*t,this.camera2D.right=15*t,this.camera2D.top=15,this.camera2D.bottom=-15,this.camera2D.updateProjectionMatrix(),this.camera3D.aspect=t,this.camera3D.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}animate(){requestAnimationFrame(this.animate),"3D"===this.guiParams.viewMode&&this.controls.update();let t=this.clock.getDelta()*this.guiParams.timeScale;this.accumulator+=t,this.elapsedTime+=t;let i=1/60;for(;this.accumulator>=i;)this.guiParams.isRunning&&(this.physics.isStable?(this.guiParams.isRunning=!1,this.clock.stop()):(this.physics.step(i),this.updateWaterColors(i))),this.accumulator-=i;this.physics.isStable||this.updateWaterMeshes(),this.updatePipeWaterLevels(),this.guiParams.isRunning?this.updateCascade(t):this.updateCascade(0),this.updateTextLabels(),this.renderer.render(this.scene,this.camera)}}document.addEventListener("DOMContentLoaded",()=>{try{new o("scene-container")}catch(t){console.error("Impossibile inizializzare la scena:",t),document.GetElementById("scene-container").innerHTML="<h3>Errore durante l'inizializzazione della simulazione.</h3><pre>"+t.stack+"</pre>"}});
//# sourceMappingURL=heron_fountain_simulation.ad5b016c.js.map
