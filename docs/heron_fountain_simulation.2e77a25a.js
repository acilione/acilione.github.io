class t{constructor(t="scene-container"){if(this.container=document.getElementById(t),!this.container)throw Error(`Container element with id '${t}' not found.`);this.guiParams={isRunning:!1,timeScale:1,viewMode:"3D",playPause:()=>{this.guiParams.isRunning=!this.guiParams.isRunning,this.handlePlayPause()},reset:()=>{this.resetAll()}},this.clock=new THREE.Clock(!1),this.elapsedTime=0,this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.controls=null,this.camera2D=null,this.camera3D=null,this.camera=null,this.h_jet=0,this.scale=20,this.physics=new HeronPhysics,this.waterA=null,this.waterB=null,this.waterC=null,this.waterCascade=null,this.waterPipe14=null,this.waterPipe56=null,this.pipe56=null,this.cascadeCurve=null,this.textOverlay=null,this.textGroups={},this.dyeMassA={r:0,g:0,b:0},this.dyeMassB={r:0,g:0,b:0},this.dyeMassC={r:0,g:0,b:0},this.initialConcentration=1,this.H_scaled=this.physics.H*this.scale,this.h6_scaled=this.physics.h_6*this.scale,this.worldWidth=.3*this.scale,this.worldDepth=.1*this.scale,this.internalWallBCH=.22*this.scale,this.topBasinY=this.H_scaled,this.topBasinHeight=6,this.pipeInnerRadius=Math.sqrt(this.physics.S/Math.PI),this.pipeOuterRadius=this.pipeInnerRadius+.001,this.jetRadius=this.pipeInnerRadius,this.initThree(),this.setupSceneGeometry(),this.setupGUI(),this.addTextLabels(),this.resetAll(),this.animate=this.animate.bind(this),this.animate()}initThree(){this.scene.background=new THREE.Color(1710634),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.container.appendChild(this.renderer.domElement);let t=this.container.clientWidth/this.container.clientHeight;this.camera2D=new THREE.OrthographicCamera(-15*t,15*t,15,-15,.1,100),this.camera2D.position.set(0,0,50),this.camera2D.lookAt(0,this.H_scaled,0),this.camera3D=new THREE.PerspectiveCamera(50,t,.1,200),this.camera3D.position.set(15,12,25),this.camera3D.lookAt(0,this.H_scaled,0),this.camera=this.camera3D,this.controls=new OrbitControls(this.camera3D,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.target.set(0,this.H_scaled,0),this.controls.enabled="3D"===this.guiParams.viewMode;let e=new THREE.AmbientLight(0xffffff,.7);this.scene.add(e);let s=new THREE.DirectionalLight(0xffffff,1);s.position.set(10,20,15),s.castShadow=!0,this.scene.add(s),window.addEventListener("resize",this.onWindowResize.bind(this))}setupSceneGeometry(){let t=new THREE.MeshPhysicalMaterial({transmission:.9,thickness:1.5*this.scale,roughness:.1,ior:1.33,transparent:!0,opacity:.85,side:THREE.DoubleSide,depthWrite:!0}),e=new THREE.MeshPhysicalMaterial({color:0xffffff,transmission:.95,thickness:.5,roughness:.05,ior:1.52,transparent:!0,opacity:.6,side:THREE.DoubleSide,depthWrite:!1}),s=this.worldWidth/2,i=this.worldDepth,a=new THREE.MeshPhysicalMaterial({...t}),h=new THREE.MeshPhysicalMaterial({...t}),r=new THREE.MeshPhysicalMaterial({...t}),n=new THREE.BoxGeometry(1,1,1);this.waterA=new THREE.Mesh(n,a),this.waterA.scale.set(this.worldWidth,1,i),this.waterA.renderOrder=2,this.scene.add(this.waterA),this.waterB=new THREE.Mesh(n,h),this.waterB.scale.set(s,1,i),this.waterB.position.x=-s/2,this.waterB.renderOrder=2,this.scene.add(this.waterB),this.waterC=new THREE.Mesh(n,r),this.waterC.scale.set(s,1,i),this.waterC.position.x=s/2,this.waterC.renderOrder=2,this.scene.add(this.waterC);let l=(t,s,i,a,h,r)=>{let n=new THREE.BoxGeometry(t,s,i),l=new THREE.Mesh(n,e.clone());return l.position.set(a,h,r),l.renderOrder=1,this.scene.add(l),l};l(this.worldWidth+.4,.2,i+.4,0,-.1,0),l(this.worldWidth+.4,.2,i+.4,0,this.H_scaled,0),l(this.worldWidth+.4,.2,i+.4,0,this.topBasinY+this.topBasinHeight,0);let o=this.topBasinY+this.topBasinHeight;l(.2,o,i+.2,-this.worldWidth/2-.1,o/2-.1,0),l(.2,o,i+.2,this.worldWidth/2+.1,o/2-.1,0),l(this.worldWidth+.4,o,.2,0,o/2-.1,-i/2-.1),l(this.worldWidth+.4,o,.2,0,o/2-.1,i/2+.1),l(.2,this.internalWallBCH,i,0,this.internalWallBCH/2,0);let c=this.scale,d=this.pipeInnerRadius*c,p=this.pipeOuterRadius*c,w=(t,s,i,a,h,r)=>{let n=new THREE.Shape;n.absarc(0,0,t,0,2*Math.PI,!1);let l=new THREE.Path;l.absarc(0,0,s,0,2*Math.PI,!0),n.holes.push(l);let o=new THREE.ExtrudeGeometry(n,{depth:i,bevelEnabled:!1}),c=new THREE.Mesh(o,e.clone());return c.rotation.x=Math.PI/2,c.position.set(a,h+i/2,r),c.renderOrder=1,this.scene.add(c),c};w(p,d,this.H_scaled,-s/2,this.H_scaled/2,0),this.pipe56=w(p,d,this.h6_scaled,s/2,this.h6_scaled/2,0);let y=new THREE.CylinderGeometry(d,d,this.H_scaled,16);this.waterPipe14=new THREE.Mesh(y,t.clone()),this.waterPipe14.position.set(-s/2,this.H_scaled/2,0),this.waterPipe14.visible=!1,this.waterPipe14.renderOrder=2,this.scene.add(this.waterPipe14);let m=new THREE.CylinderGeometry(d,d,this.h6_scaled,16);this.waterPipe56=new THREE.Mesh(m,t.clone()),this.waterPipe56.position.set(s/2,this.h6_scaled/2,0),this.waterPipe56.visible=!1,this.waterPipe56.renderOrder=2,this.scene.add(this.waterPipe56);let u=new THREE.MeshPhysicalMaterial({...t}),E=new THREE.LineCurve3(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1)),M=new THREE.TubeGeometry(E,20,this.jetRadius*c,8,!1);this.waterCascade=new THREE.Mesh(M,u),this.waterCascade.visible=!1,this.waterCascade.renderOrder=3,this.scene.add(this.waterCascade)}setupGUI(){let t=new GUI({title:"Heron's Fountain Controls"});t.add(this.guiParams,"playPause").name("▶️ / ⏸️ Start/Pause"),t.add(this.guiParams,"reset").name("\uD83D\uDD04 Reset All"),t.add(this.guiParams,"timeScale",.1,5,.1).name("Time Scale"),t.add(this.guiParams,"viewMode",["2D","3D"]).name("View Mode").onChange(t=>{this.camera="2D"===t?this.camera2D:this.camera3D,this.controls.enabled="3D"===t,this.onWindowResize()})}resetColors(){let t=this.physics.y0[0]*this.physics.S_B,e=this.physics.y0[1]*this.physics.S_B,s=this.physics.y0[2]*this.physics.S_C;this.dyeMassA={r:t*this.initialConcentration,g:0,b:0},this.dyeMassB={r:0,g:e*this.initialConcentration,b:0},this.dyeMassC={r:0,g:0,b:s*this.initialConcentration},this.waterA&&this.waterA.material.color.setRGB(1,0,0),this.waterB&&this.waterB.material.color.setRGB(0,1,0),this.waterC&&this.waterC.material.color.setRGB(0,0,1),this.waterCascade&&this.waterCascade.material.color.setRGB(0,0,1)}resetAll(){this.guiParams.isRunning=!1,this.clock.stop(),this.elapsedTime=0,this.physics.reset(),this.h_jet=0,this.resetColors(),this.updateWaterMeshes(),this.waterCascade.visible=!1,this.waterPipe14&&(this.waterPipe14.visible=!1),this.waterPipe56&&(this.waterPipe56.visible=!1),this.updateTextLabels(),this.updateWaterColors(0)}handlePlayPause(){this.guiParams.isRunning?(this.physics.isStable&&this.resetAll(),this.guiParams.isRunning=!0,this.clock.start()):this.clock.stop()}updateWaterMeshes(){let{h_A:t,h_B:e,h_C:s}=this.physics,i=this.scale,a=Math.max(.01,t*i),h=Math.max(.01,e*i);this.waterB.visible=e>0;let r=Math.max(.01,s*i);this.waterA.scale.y=a,this.waterA.position.y=this.H_scaled+a/2,this.waterB.scale.y=h,this.waterB.position.y=h/2,this.waterC.scale.y=r,this.waterC.position.y=r/2}updateCascade(t){if(this.physics.isStable){this.waterCascade.visible=!1;return}let e=Math.max(0,this.physics.v4);if(e<.1||!this.guiParams.isRunning){this.waterCascade.visible=!1;return}this.waterCascade.visible=!0;let s=this.scale,i=this.physics.g,a=this.pipe56.position.x,h=this.pipe56.position.z,r=this.h6_scaled,n=this.waterA.position.y+this.waterA.scale.y/2,l=85*Math.PI/180,o=e*Math.sin(l),c=e*Math.cos(l),d=n-.5*this.jetRadius*s,p=.5*i*s,w=-o*s,y=w*w-4*p*(d-r),m=0;y>=0&&(m=(-w+Math.sqrt(y))/(2*p));let u=-c*(m=isNaN(m)?.2:Math.max(.1,m))*s,E=new THREE.Vector3(a,r,h),M=new THREE.Vector3(a+u,d,h),C=o/i,x=Math.max(r+o*C*s-.5*i*C*C*s,r),H=new THREE.Vector3(E.x+(M.x-E.x)*(1/3),x,E.z),R=new THREE.Vector3(E.x+(M.x-E.x)*(2/3),x,M.z);this.cascadeCurve=new THREE.CubicBezierCurve3(E,H,R,M),this.waterCascade.geometry&&this.waterCascade.geometry.dispose(),this.waterCascade.geometry=new THREE.TubeGeometry(this.cascadeCurve,30,this.jetRadius*s,8,!1),this.h_jet=o*o/(2*i)}updateWaterColors(t){if(t<=0)return;let e=this.physics.h_A*this.physics.S_B+1e-6,s=this.physics.h_B*this.physics.S_B+1e-6,i=this.physics.h_C*this.physics.S_C+1e-6,a=this.physics.gamma*this.physics.v4*this.physics.S_C*t,h=this.physics.beta*this.physics.v2*this.physics.S_B*t;if(a>0&&this.physics.v4>.01){let t=this.dyeMassC.r/i,e=this.dyeMassC.g/i,s=this.dyeMassC.b/i,h=t*a,r=e*a,n=s*a;this.dyeMassA.r+=h,this.dyeMassA.g+=r,this.dyeMassA.b+=n,this.dyeMassC.r=Math.max(0,this.dyeMassC.r-h),this.dyeMassC.g=Math.max(0,this.dyeMassC.g-r),this.dyeMassC.b=Math.max(0,this.dyeMassC.b-n)}if(h>0&&this.physics.v2>.01){let t=this.dyeMassA.r/e,s=this.dyeMassA.g/e,i=this.dyeMassA.b/e,a=t*h,r=s*h,n=i*h;this.dyeMassB.r+=a,this.dyeMassB.g+=r,this.dyeMassB.b+=n,this.dyeMassA.r=Math.max(0,this.dyeMassA.r-a),this.dyeMassA.g=Math.max(0,this.dyeMassA.g-r),this.dyeMassA.b=Math.max(0,this.dyeMassA.b-n)}let r=t=>Math.max(0,Math.min(t,1)),n=r(this.dyeMassA.r/e/this.initialConcentration),l=r(this.dyeMassA.g/e/this.initialConcentration),o=r(this.dyeMassA.b/e/this.initialConcentration),c=r(this.dyeMassB.r/s/this.initialConcentration),d=r(this.dyeMassB.g/s/this.initialConcentration),p=r(this.dyeMassB.b/s/this.initialConcentration),w=r(this.dyeMassC.r/i/this.initialConcentration),y=r(this.dyeMassC.g/i/this.initialConcentration),m=r(this.dyeMassC.b/i/this.initialConcentration);this.waterA.material.color.setRGB(r(1-l-o),r(1-n-o),r(1-n-l)),this.waterB.material.color.setRGB(r(1-d-p),r(1-c-p),r(1-c-d)),this.waterC.material.color.setRGB(r(1-y-m),r(1-w-m),r(1-w-y)),this.waterCascade.material.color.copy(this.waterC.material.color),this.waterPipe56.material.color.copy(this.waterC.material.color),this.waterPipe14.material.color.copy(this.waterA.material.color)}addTextLabels(){this.textOverlay&&this.textOverlay.remove(),this.textOverlay=document.createElement("div"),this.textOverlay.className="text-label-overlay",this.container.appendChild(this.textOverlay);let t=t=>{let e=document.createElement("div");return e.className="label-group",e.id=t,this.textOverlay.appendChild(e),e};this.textGroups.A=t("label-A"),this.textGroups.B=t("label-B"),this.textGroups.C=t("label-C"),this.textGroups.Time=t("label-Time"),this.textGroups.Jet=t("label-Jet")}toScreenPosition(t,e,s){let i=s.clientWidth,a=s.clientHeight,h=t.clone().project(e);return h.x=(h.x+1)/2*i,h.y=-(h.y-1)/2*a,{x:h.x,y:h.y}}updateTextLabels(){if(!this.textGroups.A)return;this.scale;let t=this.renderer.domElement,e=new THREE.Vector3(0,this.H_scaled+this.topBasinHeight-1,0),s=new THREE.Vector3(-this.worldWidth/4,this.H_scaled-1,0),i=new THREE.Vector3(this.worldWidth/4,this.H_scaled-1,0),a=new THREE.Vector3(this.worldWidth/4,this.h6_scaled+2,0),h=this.toScreenPosition(e,this.camera,t);this.textGroups.A.style.left=`${h.x}px`,this.textGroups.A.style.top=`${h.y}px`,this.textGroups.A.innerHTML=`
                <div>Basin A</div>
                <div>h_A: ${(100*this.physics.h_A).toFixed(1)} cm</div>
                `;let r=this.toScreenPosition(s,this.camera,t);this.textGroups.B.style.left=`${r.x}px`,this.textGroups.B.style.top=`${r.y}px`,this.textGroups.B.innerHTML=`
                <div>Basin B</div>
                <div>h_B: ${(100*this.physics.h_B).toFixed(1)} cm</div>
                `;let n=this.toScreenPosition(i,this.camera,t);this.textGroups.C.style.left=`${n.x}px`,this.textGroups.C.style.top=`${n.y}px`,this.textGroups.C.innerHTML=`
                <div>Basin C</div>
                <div>h_C: ${(100*this.physics.h_C).toFixed(1)} cm</div>
                `;let l=this.toScreenPosition(a,this.camera,t);this.textGroups.Jet.style.left=`${l.x}px`,this.textGroups.Jet.style.top=`${l.y}px`,this.textGroups.Jet.innerHTML=`
                <div>Jet</div>
                <div>v_4: ${this.physics.v4.toFixed(2)} m/s</div>
                <div>h_jet: ${(100*this.h_jet).toFixed(1)} cm</div>
                `,this.textGroups.Time.style.left="50%",this.textGroups.Time.style.top="20px";let o=this.physics.isStable?"STABLE (B empty)":this.guiParams.isRunning?"RUNNING":"PAUSED";this.textGroups.Time.innerHTML=`
                <div>Time: ${this.physics.t.toFixed(2)} s</div>
                <div>State: ${o}</div>
                `}onWindowResize(){let t=this.container.clientWidth/this.container.clientHeight;this.camera2D.left=-15*t,this.camera2D.right=15*t,this.camera2D.top=15,this.camera2D.bottom=-15,this.camera2D.updateProjectionMatrix(),this.camera3D.aspect=t,this.camera3D.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)}animate(){if(requestAnimationFrame(this.animate),"3D"===this.guiParams.viewMode&&this.controls.update(),this.guiParams.isRunning){let t=this.clock.getDelta()*this.guiParams.timeScale;this.elapsedTime+=t,this.physics.isStable?(this.guiParams.isRunning=!1,this.clock.stop(),this.waterPipe14.visible=!1,this.waterPipe56.visible=!1):(this.physics.step(t),this.updateWaterMeshes(),this.updateWaterColors(t)),this.updateCascade(t),this.waterPipe14.visible=this.physics.v2>.01,this.waterPipe56.visible=this.physics.v4>.01}else this.updateCascade(0),this.waterPipe14.visible=!1,this.waterPipe56.visible=!1;this.updateTextLabels(),this.renderer.render(this.scene,this.camera)}}document.addEventListener("DOMContentLoaded",()=>{try{new t("scene-container")}catch(t){console.error("Impossibile inizializzare la scena:",t),document.getElementById("scene-container").innerHTML="<h3>Errore durante l'inizializzazione della simulazione.</h3><pre>"+t.stack+"</pre>"}});
//# sourceMappingURL=heron_fountain_simulation.2e77a25a.js.map
